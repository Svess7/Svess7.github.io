<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Charts • Stocks & Crypto</title>
<link rel="stylesheet" href="styles.css" />
<body>
<header class="container">
  <div class="brand"><a href="index.html">Svess7</a></div>
  <nav><a href="index.html">Home</a> <a href="chart.html" aria-current="page">Charts</a></nav>
 </header>

<main class="container">
  <section class="hero">
    <h1>Interactive Market Charts</h1>
    <p class="muted">Choose market, ticker, indicator, and time range to view a chart.</p>
  </section>

  <section class="panel" style="padding:12px 12px 0">
    <form id="controls" class="form-grid" autocomplete="off">
      <label>
        <div class="muted">Market</div>
        <select id="market">
          <option value="stocks" selected>US Stocks</option>
          <option value="crypto">Crypto</option>
        </select>
      </label>
      <label>
        <div class="muted">Ticker</div>
        <input id="ticker" placeholder="AAPL or BTC" />
      </label>
      <label>
        <div class="muted">Indicator</div>
        <select id="indicator">
          <option value="none" selected>None</option>
          <option value="sma">SMA</option>
          <option value="ema">EMA</option>
          <option value="rsi">RSI</option>
          <option value="macd">MACD</option>
        </select>
      </label>
      <label>
        <div class="muted">Range</div>
        <select id="range">
          <option value="1M">1M</option>
          <option value="3M">3M</option>
          <option value="6M">6M</option>
          <option value="1Y" selected>1Y</option>
          <option value="5Y">5Y</option>
          <option value="max">Max</option>
        </select>
      </label>
      <div class="form-actions">
        <button id="loadBtn" class="btn" type="submit">Get graph</button>
      </div>
    </form>
  </section>

  <section class="panel" style="margin-top:12px; padding:12px">
    <canvas id="chart" height="420"></canvas>
    <div id="note" class="muted" style="margin-top:8px"></div>
  </section>
 </main>

<footer class="container muted">© <span id="y"></span> Svess7</footer>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
document.getElementById("y").textContent = new Date().getFullYear();

const elForm = document.getElementById("controls");
const elMarket = document.getElementById("market");
const elTicker = document.getElementById("ticker");
const elIndicator = document.getElementById("indicator");
const elRange = document.getElementById("range");
const elNote = document.getElementById("note");

let chart;

elForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const market = elMarket.value;
  const tickerRaw = elTicker.value.trim();
  const indicator = elIndicator.value;
  const range = elRange.value;
  if (!tickerRaw) { elNote.textContent = "Please enter a ticker (e.g., AAPL or BTC)."; return; }
  elNote.textContent = "Loading…";
  try {
    const series = market === "stocks"
      ? await fetchStocksSeries(tickerRaw, range)
      : await fetchCryptoSeries(tickerRaw, range);

    const datasets = buildDatasets(series, indicator);
    renderChart(series.dates, datasets, indicator);
    elNote.textContent = sourceNote(market, tickerRaw, range);
  } catch (err) {
    console.error(err);
    elNote.textContent = "Failed to load data. Try a different symbol or range.";
  }
});

function sourceNote(market, t, r){
  if (market === "stocks") return `Data: Stooq (EOD). Symbol: ${t.toUpperCase()} Range: ${r}`;
  return `Data: CoinGecko (daily). Asset: ${t.toUpperCase()} Range: ${r}`;
}

async function fetchStocksSeries(symbol, range){
  // Using Stooq free CSV (EOD). Mapping range via client-side slice.
  // Symbols on Stooq often use different tickers; try raw upper and Nasdaq IQ suffix.
  const s = symbol.toUpperCase();
  const url = `https://stooq.com/q/d/l/?s=${encodeURIComponent(s)}&i=d`;
  const res = await fetch(url, { mode: "cors" });
  if (!res.ok) throw new Error("Stocks fetch failed");
  const csv = await res.text();
  const rows = csv.trim().split(/\n/).slice(1).map(r=>r.split(","));
  const dates = [];
  const closes = [];
  for (const r of rows){
    const d = r[0];
    const c = parseFloat(r[4]);
    if (!isFinite(c)) continue;
    dates.push(d);
    closes.push(c);
  }
  const { dates: d2, closes: c2 } = sliceRange(dates, closes, range);
  return { dates: d2, closes: c2 };
}

async function fetchCryptoSeries(symbol, range){
  // Map common tickers to CoinGecko ids (simple). If unknown, try search API.
  const id = await resolveCoinId(symbol);
  const days = rangeToDays(range);
  const url = `https://api.coingecko.com/api/v3/coins/${encodeURIComponent(id)}/market_chart?vs_currency=usd&days=${days}`;
  const res = await fetch(url, { headers: { "accept": "application/json" }});
  if (!res.ok) throw new Error("Crypto fetch failed");
  const data = await res.json();
  const prices = data.prices || [];
  const dates = prices.map(p=> new Date(p[0]).toISOString().slice(0,10));
  const closes = prices.map(p=> p[1]);
  return sliceRange(dates, closes, range);
}

async function resolveCoinId(symbol){
  const map = { BTC: "bitcoin", ETH: "ethereum", SOL: "solana", ADA: "cardano", XRP: "ripple", DOGE: "dogecoin" };
  const upper = symbol.toUpperCase();
  if (map[upper]) return map[upper];
  const q = upper.toLowerCase();
  const res = await fetch(`https://api.coingecko.com/api/v3/search?query=${encodeURIComponent(q)}`);
  const data = await res.json();
  const c = (data.coins||[]).find(x=> x.symbol.toUpperCase() === upper) || (data.coins||[])[0];
  if (!c) throw new Error("Coin not found");
  return c.id;
}

function rangeToDays(r){
  switch(r){
    case "1M": return 31; case "3M": return 93; case "6M": return 186; case "1Y": return 365; case "5Y": return 365*5; default: return "max";
  }
}

function sliceRange(dates, values, range){
  const n = dates.length;
  let keep = n;
  switch(range){
    case "1M": keep = 31; break;
    case "3M": keep = 93; break;
    case "6M": keep = 186; break;
    case "1Y": keep = 365; break;
    case "5Y": keep = 365*5; break;
    case "max": default: keep = n; break;
  }
  const start = Math.max(0, n - keep);
  return { dates: dates.slice(start), closes: values.slice(start) };
}

function buildDatasets(series, indicator){
  const datasets = [
    {
      type: "line",
      label: "Close",
      data: series.closes,
      borderColor: "#3ea6ff",
      borderWidth: 2,
      pointRadius: 0,
      tension: 0.15
    }
  ];
  if (indicator === "sma"){
    const sma = simpleMovingAverage(series.closes, 20);
    datasets.push(line("SMA(20)", sma, "#ffb74d"));
  } else if (indicator === "ema"){
    const ema = exponentialMovingAverage(series.closes, 20);
    datasets.push(line("EMA(20)", ema, "#ff7043"));
  } else if (indicator === "rsi"){
    const rsi = relativeStrengthIndex(series.closes, 14);
    datasets.push(line("RSI(14)", rsi, "#ab47bc", 1));
  } else if (indicator === "macd"){
    const { macd, signal } = macdSeries(series.closes, 12, 26, 9);
    datasets.push(line("MACD", macd, "#26a69a"));
    datasets.push(line("Signal", signal, "#ef5350"));
  }
  return datasets;
}

function line(label, data, color, yAxis=0){
  return { type: "line", label, data, borderColor: color, borderWidth: 2, pointRadius: 0, tension: 0.15, yAxisID: yAxis };
}

function renderChart(labels, datasets, indicator){
  const ctx = document.getElementById("chart").getContext("2d");
  if (chart) chart.destroy();
  const scales = { y: { grid: { color: "rgba(255,255,255,.08)" } }, x: { ticks: { maxTicksLimit: 12 } } };
  if (indicator === "rsi"){
    scales.y.min = 0; scales.y.max = 100;
  }
  chart = new Chart(ctx, {
    data: { labels, datasets },
    options: {
      responsive: true,
      interaction: { mode: "index", intersect: false },
      plugins: { legend: { display: true } },
      scales
    }
  });
}

function simpleMovingAverage(values, period){
  const out = new Array(values.length).fill(null);
  let sum = 0;
  for (let i=0;i<values.length;i++){
    sum += values[i];
    if (i >= period) sum -= values[i - period];
    if (i >= period - 1) out[i] = sum / period;
  }
  return out;
}

function exponentialMovingAverage(values, period){
  const k = 2 / (period + 1);
  const out = new Array(values.length).fill(null);
  let prev;
  for (let i=0;i<values.length;i++){
    const v = values[i];
    prev = i === 0 ? v : (v - prev) * k + prev;
    if (i >= period - 1) out[i] = prev;
  }
  return out;
}

function relativeStrengthIndex(values, period){
  const out = new Array(values.length).fill(null);
  let gain = 0, loss = 0;
  for (let i=1;i<values.length;i++){
    const change = values[i] - values[i-1];
    const g = Math.max(0, change);
    const l = Math.max(0, -change);
    if (i <= period){
      gain += g; loss += l;
      if (i === period){
        const rs = (gain/period) / ((loss/period)||1e-9);
        out[i] = 100 - 100/(1+rs);
      }
    } else {
      gain = (gain*(period-1) + g) / period;
      loss = (loss*(period-1) + l) / period;
      const rs = gain / (loss||1e-9);
      out[i] = 100 - 100/(1+rs);
    }
  }
  return out;
}

function macdSeries(values, fast=12, slow=26, signal=9){
  const emaFast = emaFor(values, fast);
  const emaSlow = emaFor(values, slow);
  const macd = values.map((_, i)=> emaFast[i] != null && emaSlow[i] != null ? emaFast[i] - emaSlow[i] : null);
  const sig = emaFor(macd, signal);
  return { macd, signal: sig };
}
function emaFor(values, period){
  const k = 2 / (period + 1);
  const out = new Array(values.length).fill(null);
  let prev;
  for (let i=0;i<values.length;i++){
    const v = values[i];
    if (v == null) { if (prev != null) out[i] = prev; continue; }
    prev = i === 0 || prev == null ? v : (v - prev) * k + prev;
    if (i >= period - 1) out[i] = prev;
  }
  return out;
}
</script>
</body>
</html>


